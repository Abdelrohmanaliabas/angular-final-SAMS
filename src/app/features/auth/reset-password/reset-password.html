<div class="auth-card
            p-8 relative z-10 flex flex-col justify-center items-center
            w-full min-h-screen md:w-[45vw] md:min-h-[70vh]
            md:rounded-3xl rounded-none
            transition-all duration-[700ms]">
  <div class="w-full max-w-xl mx-auto">
    <ng-container *ngIf="!contextLoading(); else loadingContext">
      <ng-container *ngIf="resetContext?.token && resetContext?.email; else invalidToken">
        <form [formGroup]="resetPasswordForm" (ngSubmit)="onSubmit()">
          <h2 class="text-2xl font-semibold text-center mb-6">Create a new password</h2>

          <p class="auth-hero-copy mb-4">
            Resetting password for <strong>{{ resetContext?.email }}</strong>.
          </p>

        <!-- Password -->
        <label class="text-sm font-medium mt-3 mb-1 block">New Password</label>
        <div class="password-field mb-1">
          <input [type]="passwordVisibility.password ? 'text' : 'password'" formControlName="password"
            class="auth-input" />
          <button type="button" class="password-toggle" (click)="togglePasswordVisibility('password')" aria-label="Toggle password visibility">
            <i class="fa-solid" [ngClass]="passwordVisibility.password ? 'fa-eye-slash' : 'fa-eye'"></i>
          </button>
        </div>
        <div class="auth-error mt-1"
          *ngIf="resetPasswordForm.get('password')?.touched && resetPasswordForm.get('password')?.invalid">
          <span *ngIf="resetPasswordForm.get('password')?.errors?.['required']">Password is required.</span>
          <span *ngIf="resetPasswordForm.get('password')?.errors?.['minlength']">Password must be at least 8 characters.</span>
          <span *ngIf="resetPasswordForm.get('password')?.errors?.['pattern']">Password must contain uppercase, lowercase, number & symbol.</span>
        </div>

        <!-- Confirm Password -->
        <label class="text-sm font-medium mt-3 mb-1 block">Confirm Password</label>
        <div class="password-field mb-1">
          <input [type]="passwordVisibility.confirm ? 'text' : 'password'" formControlName="confirmPassword"
            class="auth-input" />
          <button type="button" class="password-toggle" (click)="togglePasswordVisibility('confirm')" aria-label="Toggle confirm password visibility">
            <i class="fa-solid" [ngClass]="passwordVisibility.confirm ? 'fa-eye-slash' : 'fa-eye'"></i>
          </button>
        </div>
        <div class="auth-error mt-1" *ngIf="(resetPasswordForm.get('confirmPassword')?.touched || resetPasswordForm.get('password')?.touched) &&
                      (resetPasswordForm.get('confirmPassword')?.invalid || resetPasswordForm.errors?.['mismatch'])">
          <span *ngIf="resetPasswordForm.get('confirmPassword')?.errors?.['required']">Confirm Password is required.</span>
          <span *ngIf="resetPasswordForm.errors?.['mismatch']">Passwords do not match.</span>
        </div>

        <!-- Submit -->
          <button type="submit"
            class="auth-button mt-3 w-full py-3">
            Save new password
          </button>
        </form>
      </ng-container>
    </ng-container>
  </div>
</div>

<ng-template #loadingContext>
  <div class="text-center">
    <div class="text-4xl mb-4 animate-bounce">⏳</div>
    <h2 class="text-xl font-semibold">Loading secure reset link...</h2>
    <p class="auth-hero-copy mt-2 mb-4">
      Please wait while we verify your link.
    </p>
  </div>
</ng-template>

<ng-template #invalidToken>
  <div class="text-center">
    <div class="text-4xl mb-4">⏳</div>
    <h2 class="text-xl font-semibold">Reset link expired</h2>
    <p class="auth-hero-copy mt-2 mb-4">
      Reset links only work for 30 minutes. Request a new one.
    </p>
    <button (click)="onSwitch('forgot-password')"
      class="auth-button w-full py-3">
      Request new link
    </button>
  </div>
</ng-template>
